<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ibrahim POS - WhatsApp Cloud Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f4f7f6; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; display: flex; background: var(--bg); color: #333; }
        .sidebar { width: 260px; background: var(--primary); color: white; height: 100vh; position: fixed; padding: 20px; z-index: 100; }
        .sidebar h2 { text-align: center; color: var(--accent); border-bottom: 1px solid #444; padding-bottom: 10px; margin-top: 0; }
        .sidebar button { width: 100%; padding: 12px; margin: 8px 0; background: none; border: none; color: #bdc3c7; text-align: left; cursor: pointer; border-radius: 6px; font-size: 15px; display: flex; align-items: center; gap: 10px; }
        .sidebar button:hover, .sidebar button.active { background: #34495e; color: #fff; border-left: 5px solid var(--accent); }
        .main { margin-left: 260px; flex: 1; padding: 30px; min-height: 100vh; }
        .section { display: none; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section.active { display: block; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; font-weight: 600; font-size: 12px; color: #666; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 11px; margin: 2px; }
        .btn-green { background: var(--accent); color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-wa { background: #25D366; color: white; } /* WhatsApp Color */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; width: 90%; max-width: 500px; margin: 40px auto; padding: 20px; border-radius: 12px; position: relative; }
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        @media print {
            @page { size: 80mm auto; margin: 0; }
            html, body { height: auto; background: white; width: 80mm; margin: 0; padding: 0; }
            .sidebar, .no-print, .btn, .input-group, #loginOverlay, .modal, th:last-child, td:last-child { display: none !important; }
            .main { margin: 0 !important; padding: 10px !important; width: 80mm !important; }
            .section { display: none !important; }
            #billing.section.active { display: block !important; box-shadow: none !important; border: none !important; }
            .thermal-header { display: block !important; text-align: center; }
            .thermal-header h1 { font-size: 20px; margin: 5px 0; font-weight: bold; }
            .thermal-header p { font-size: 12px; margin: 2px 0; }
            .dashed-line { border-top: 1px dashed #000; margin: 5px 0; display: block !important; }
            .solid-line { border-top: 1px solid #000; margin: 5px 0; display: block !important; }
            table { width: 100%; font-size: 12px; margin-top: 5px; }
            th, td { padding: 4px 0 !important; border: none !important; color: #000 !important; }
            .bill-summary { display: block !important; margin-top: 10px; font-size: 13px; text-align: right; border-top: 1px solid #000; padding-top: 5px; }
            .bill-summary b { font-size: 16px; }
        }
        .thermal-header, .bill-summary, .dashed-line, .solid-line { display: none; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 id="logShop">Ibrahim POS</h2>
        <input type="text" id="user" placeholder="Username" style="width:100%; margin-bottom:15px;">
        <input type="password" id="pass" placeholder="Password" style="width:100%; margin-bottom:15px;">
        <button onclick="checkLogin()" class="btn btn-green" style="width:100%; padding:15px;">Login</button>
    </div>
</div>

<div class="sidebar" id="sidebarUI" style="display:none;">
    <h2 id="sideShop">IBRAHIM POS</h2>
    <button onclick="showPage('billing')" id="btn-billing" class="active">üõí Sale Invoice</button>
    <button onclick="showPage('inventory')" id="btn-inventory">üì¶ Stock Items</button>
    <button onclick="showPage('customers')" id="btn-customers">üë• Customers</button>
    <button onclick="showPage('reports')" id="btn-reports">üìä Reports</button>
    <button onclick="openSettings()" id="btn-settings" style="margin-top:50px;">‚öôÔ∏è Settings</button>
    <button onclick="location.reload()" style="color:#e74c3c;">Logout</button>
</div>

<div class="main" id="mainUI" style="display:none;">
    <div id="billing" class="section active">
        <div class="thermal-header">
            <h1 id="pStoreName"></h1>
            <p id="pStoreAddr"></p>
            <p id="pStoreContact"></p>
            <p>Date: <span id="printDate"></span></p>
            <p id="pCustNameDisplay" style="font-weight: bold; margin-top:5px;"></p>
        </div>
        <div class="dashed-line"></div>
        <div class="input-group no-print">
            <select id="saleType" onchange="toggleCust()"><option value="cash">Cash Sale</option><option value="udhaar">Udhaar (Credit)</option></select>
            <select id="billCustSelect" onchange="updateOldBalanceDisplay()" style="display:none; flex:1;"></select>
            <select id="billItemSelect" style="flex:2;"></select>
            <input type="number" id="billQty" value="1" style="width:80px;">
            <button class="btn btn-green" onclick="addToCart()">Add</button>
        </div>
        <table>
            <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Total</th><th class="no-print">X</th></tr></thead>
            <tbody id="cartTable"></tbody>
        </table>
        <div class="dashed-line"></div>
        <div class="solid-line"></div>
        <div class="bill-summary">
            <div>Old Balance: <span id="sOldBal">0</span></div>
            <div>Current Bill: <span id="sCurBill">0</span></div>
            <div style="margin-top:5px;"><b>Total Payable: <span id="sTotalPay">0</span></b></div>
        </div>
        <h1 class="no-print" style="text-align:right;">Bill: <span id="gTotal">0</span> PKR</h1>
        <div class="no-print" style="text-align:right;">
            <button class="btn btn-wa" onclick="sendWhatsApp()">üì± WhatsApp Bill</button>
            <button class="btn btn-blue" onclick="preparePrint()">üñ®Ô∏è Thermal Print</button>
            <button class="btn btn-green" onclick="finishSale()">‚úÖ Finish Sale</button>
        </div>
    </div>

    <div id="inventory" class="section">
        <h2>üì¶ Stock</h2>
        <div class="input-group">
            <input type="text" id="pName" placeholder="Product Name">
            <input type="number" id="pBuy" placeholder="Buy Price">
            <input type="number" id="pSell" placeholder="Sell Price">
            <input type="number" id="pPack" value="1" placeholder="Pack">
            <input type="number" id="pBox" placeholder="Qty">
            <button class="btn btn-green" onclick="addProduct()">Save Stock</button>
        </div>
        <table><thead><tr><th>Product</th><th>Buy</th><th>Sell</th><th>Stock</th><th class="no-print">Action</th></tr></thead><tbody id="invBody"></tbody></table>
    </div>

    <div id="customers" class="section">
        <h2>üë• Customers</h2>
        <div class="input-group no-print"><input type="text" id="cName" placeholder="Name"><input type="text" id="cMob" placeholder="Mobile"><input type="number" id="cBal" placeholder="Bal"><button class="btn btn-blue" onclick="addCustomer()">Add</button></div>
        <table><thead><tr><th>Name</th><th>Mobile</th><th>Balance</th><th>Action</th></tr></thead><tbody id="custBody"></tbody></table>
    </div>

    <div id="reports" class="section">
        <h2>üìä Reports</h2>
        <input type="date" id="repDate" onchange="generateReport()">
        <div style="display:flex; gap:10px; margin:20px 0;">
            <div style="background:var(--accent); color:white; padding:15px; border-radius:10px; flex:1;">Sale: <h3 id="repS">0</h3></div>
            <div style="background:var(--primary); color:white; padding:15px; border-radius:10px; flex:1;">Profit: <h3 id="repP">0</h3></div>
        </div>
        <table><thead><tr><th>Item</th><th>Qty</th><th>Sale</th><th>Profit</th></tr></thead><tbody id="repBody"></tbody></table>
    </div>

    <div id="settings" class="section">
        <h2>‚öôÔ∏è Settings</h2>
        <div class="input-group"><input type="text" id="setStore" placeholder="Shop Name"><input type="text" id="setAddr" placeholder="Address"><input type="text" id="setMob" placeholder="Contact"></div>
        <button class="btn btn-blue" onclick="saveStore()">Save Store Info</button>
        <hr>
        <div class="input-group"><input type="text" id="setUser" placeholder="User"><input type="password" id="setPass" placeholder="Pass"><input type="password" id="setSPass" placeholder="Key"></div>
        <button class="btn btn-red" onclick="saveSecurity()">Update Passwords</button>
    </div>
</div>

<div id="ledgerModal" class="modal">
    <div class="modal-content">
        <button onclick="closeModal()" class="btn btn-red no-print" style="float:right;">X</button>
        <h3>Ledger: <span id="lHead"></span></h3>
        <div class="input-group no-print">
            <input type="number" id="pAmt" placeholder="Amount">
            <button class="btn btn-green" onclick="submitPayment()">Save Payment</button>
        </div>
        <table><thead><tr><th>Date</th><th>Note</th><th>Dr</th><th>Cr</th><th>Bal</th></tr></thead><tbody id="lBody"></tbody></table>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDKYGyExqdL-qmilgycU2_0_t44FrzQedA",
      authDomain: "ibrahim-pos.firebaseapp.com",
      databaseURL: "https://ibrahim-pos-default-rtdb.firebaseio.com",
      projectId: "ibrahim-pos",
      storageBucket: "ibrahim-pos.firebasestorage.app",
      messagingSenderId: "787583279586",
      appId: "1:787583279586:web:a8abc8bdf565e3133e59bb"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let config = { storeName: "Ibrahim Mobile", mobile: "03017900460", address: "Main Bazar", user: "admin", pass: "1234", sPass: "5555" };
    let products = [], customers = [], sales = [], cart = [], activeCIDX = null;

    db.ref('/').on('value', (snapshot) => {
        const data = snapshot.val();
        if(data) {
            products = data.products || [];
            customers = data.customers || [];
            sales = data.sales || [];
            config = data.config || config;
            updateUI(); refreshUI();
        }
    });

    function save() { db.ref('/').set({ products, customers, sales, config }); }

    // --- WHATSAPP FUNCTION ---
    function sendWhatsApp() {
    if(cart.length === 0) return alert("Pehly bill mein items add karein!");
    
    let num = "";
    let cName = "Customer";
    let balanceInfo = ""; // Balance ke liye naya variable
    let saleType = document.getElementById('saleType').value;

    if(saleType === 'udhaar') {
        let ci = document.getElementById('billCustSelect').value;
        if(ci === "") return alert("Customer select karen!");
        
        let cust = customers[ci];
        num = cust.mob;
        cName = cust.name;
        
        // Balance ki calculations
        let currentBill = parseFloat(document.getElementById('gTotal').innerText);
        let oldBalance = cust.bal; // Bill add hone se pehle ka balance
        let totalUdhaar = oldBalance + currentBill;
        
        balanceInfo = `--------------------------\n`;
        balanceInfo += `Pichla Udhaar: ${oldBalance} PKR\n`;
        balanceInfo += `*Kul Wajibul Ada: ${totalUdhaar} PKR*\n`;
    } else {
        num = prompt("Mobile Number (e.g. 923001234567):");
    }

    if(!num) return alert("WhatsApp number zaroori hai!");
    num = num.replace(/\D/g,'');
    if(!num.startsWith('92')) num = '92' + num.replace(/^0/, '');

    // Message Table
    let msgText = `*Raseed: ${config.storeName}*\n`;
    msgText += `Customer Name: ${cName}\n`;
    msgText += `Date: ${new Date().toLocaleDateString()}\n`;
    msgText += `--------------------------\n`;
    
    cart.forEach(item => {
        msgText += `${item.name} x ${item.qty} = ${item.total} PKR\n`;
    });
    
    msgText += `--------------------------\n`;
    msgText += `*Mojooda Bill: ${document.getElementById('gTotal').innerText} PKR*\n`;
    
    // Agar Udhaar hai to balance info add hogi
    msgText += balanceInfo;
    
    msgText += `\nShukriya!`;

    let encodedMsg = encodeURIComponent(msgText);
    window.open("https://wa.me/" + num + "?text=" + encodedMsg, '_blank');
}

    // --- REMAINING FUNCTIONS ---
    function checkLogin() {
        if(document.getElementById('user').value === config.user && document.getElementById('pass').value === config.pass) {
            document.getElementById('loginOverlay').style.display='none';
            document.getElementById('sidebarUI').style.display='block';
            document.getElementById('mainUI').style.display='block';
        } else alert("Ghalat Login!");
    }

    function addProduct() {
        let n = document.getElementById('pName').value.trim(), b = parseFloat(document.getElementById('pBuy').value), s = parseFloat(document.getElementById('pSell').value), pk = parseInt(document.getElementById('pPack').value || 1), q = parseInt(document.getElementById('pBox').value || 0);
        if(!n || isNaN(b)) return;
        let total = q * pk;
        let idx = products.findIndex(p => p.name.toLowerCase() === n.toLowerCase());
        if(idx !== -1) { products[idx].units += total; products[idx].buy = b; products[idx].sell = s; }
        else products.push({name: n, buy: b, sell: s, units: total});
        save();
        ['pName','pBuy','pSell','pBox'].forEach(i => document.getElementById(i).value = '');
    }

    function addCustomer() {
        let n = document.getElementById('cName').value, bl = parseFloat(document.getElementById('cBal').value || 0), mob = document.getElementById('cMob').value;
        if(!n) return;
        customers.push({name: n, mob: mob, bal: bl, history: [{date: new Date().toLocaleDateString(), desc: 'Opening', dr: bl, cr: 0, b: bl}]});
        save();
        ['cName','cMob','cBal'].forEach(i => document.getElementById(i).value = '');
    }

    function addToCart() {
        let i = document.getElementById('billItemSelect').value, q = parseInt(document.getElementById('billQty').value);
        if(i==="") return;
        let p = products[i];
        if(p.units < q) return alert("Stock kam hai!");
        cart.push({name: p.name, price: p.sell, qty: q, total: p.sell * q, pIdx: i, buy: p.buy});
        renderCart();
    }

    function renderCart() {
        let h = '', t = 0;
        cart.forEach((c, i) => { t += c.total; h += `<tr><td>${c.name}</td><td>${c.price}</td><td>${c.qty}</td><td>${c.total}</td><td class="no-print"><button onclick="cart.splice(${i},1);renderCart()">X</button></td></tr>`; });
        document.getElementById('cartTable').innerHTML = h; 
        document.getElementById('gTotal').innerText = t;
        document.getElementById('sCurBill').innerText = t;
        updateOldBalanceDisplay();
    }

    function updateOldBalanceDisplay() {
        let t = parseFloat(document.getElementById('gTotal').innerText);
        let old = 0; let cName = "";
        if(document.getElementById('saleType').value === 'udhaar') {
            let ci = document.getElementById('billCustSelect').value;
            if(ci !== "") { old = customers[ci].bal; cName = "Grahak: " + customers[ci].name; }
        }
        document.getElementById('sOldBal').innerText = old;
        document.getElementById('sTotalPay').innerText = old + t;
        document.getElementById('pCustNameDisplay').innerText = cName;
    }

    function finishSale() {
        if(cart.length === 0) return;
        let t = parseFloat(document.getElementById('gTotal').innerText), d = new Date().toISOString().split('T')[0];
        cart.forEach(c => { 
            products[c.pIdx].units -= c.qty; 
            sales.push({date: d, name: c.name, qty: c.qty, sale: c.total, profit: (c.price - c.buy) * c.qty}); 
        });
        if(document.getElementById('saleType').value === 'udhaar') {
            let ci = document.getElementById('billCustSelect').value;
            let c = customers[ci]; c.bal += t;
            c.history.push({date: new Date().toLocaleDateString(), desc: 'Invoice', dr: t, cr: 0, b: c.bal});
        }
        alert("Sale Mukammal!"); cart = []; renderCart(); save();
    }

    function preparePrint() { document.getElementById('printDate').innerText = new Date().toLocaleString(); window.print(); }
    function openLedger(i) { activeCIDX = i; document.getElementById('ledgerModal').style.display='block'; document.getElementById('lHead').innerText = customers[i].name; renderLedger(); }
    function renderLedger() { let c = customers[activeCIDX]; document.getElementById('lBody').innerHTML = c.history.map(h => `<tr><td>${h.date}</td><td>${h.desc}</td><td>${h.dr || ''}</td><td>${h.cr || ''}</td><td>${h.b}</td></tr>`).join(''); }
    function submitPayment() {
        let a = parseFloat(document.getElementById('pAmt').value), c = customers[activeCIDX];
        if(isNaN(a)) return; c.bal -= a;
        c.history.push({date: new Date().toLocaleDateString(), desc: 'Wasooli', dr: 0, cr: a, b: c.bal});
        save(); renderLedger(); document.getElementById('pAmt').value = '';
    }

    function generateReport() {
        let dt = document.getElementById('repDate').value, f = sales.filter(s => s.date === dt), h = '', ts = 0, tp = 0;
        f.forEach(s => { ts += s.sale; tp += s.profit; h += `<tr><td>${s.name}</td><td>${s.qty}</td><td>${s.sale}</td><td>${s.profit}</td></tr>`; });
        document.getElementById('repBody').innerHTML = h; document.getElementById('repS').innerText = ts; document.getElementById('repP').innerText = tp;
    }

    function showPage(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-'+id).classList.add('active');
    }

    function openSettings() { let p = prompt("Security Key:"); if(p === config.sPass) showPage('settings'); }
    function saveStore() { config.storeName = document.getElementById('setStore').value; config.address = document.getElementById('setAddr').value; config.mobile = document.getElementById('setMob').value; save(); alert("Saved!"); }
    function saveSecurity() { config.user = document.getElementById('setUser').value; config.pass = document.getElementById('setPass').value; config.sPass = document.getElementById('setSPass').value; save(); alert("Saved!"); }

    function updateUI() {
        document.getElementById('pStoreName').innerText = config.storeName;
        document.getElementById('pStoreAddr').innerText = config.address;
        document.getElementById('pStoreContact').innerText = config.mobile;
        document.getElementById('sideShop').innerText = config.storeName;
        document.getElementById('setStore').value = config.storeName;
        document.getElementById('setAddr').value = config.address;
        document.getElementById('setMob').value = config.mobile;
    }

    function refreshUI() {
        document.getElementById('invBody').innerHTML = products.map((p, i) => `<tr><td>${p.name}</td><td>${p.buy}</td><td>${p.sell}</td><td>${p.units}</td><td class="no-print"><button onclick="products.splice(${i},1);save()">X</button></td></tr>`).join('');
        document.getElementById('custBody').innerHTML = customers.map((c, i) => `<tr><td>${c.name}</td><td>${c.mob}</td><td>${c.bal}</td><td><button class="btn btn-blue" onclick="openLedger(${i})">Ledger</button></td></tr>`).join('');
        document.getElementById('billItemSelect').innerHTML = '<option value="">-- Item --</option>' + products.map((p, i) => `<option value="${i}">${p.name} (${p.units})</option>`).join('');
        document.getElementById('billCustSelect').innerHTML = '<option value="">-- Customer --</option>' + customers.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');
    }

    function toggleCust() { document.getElementById('billCustSelect').style.display = document.getElementById('saleType').value === 'udhaar' ? 'inline-block' : 'none'; updateOldBalanceDisplay(); }
    function closeModal() { document.getElementById('ledgerModal').style.display='none'; }
</script>
</body>
</html>